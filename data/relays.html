<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DPM – Relays</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="topbar">
    <div class="nav">
      <a class="btn" href="/index.html">Dashboard</a>
      <a class="btn" href="/modbus.html">Modbus</a>
      <a id="nav-relays" class="btn" href="/relays.html">Relays</a>
      <a class="btn" href="/dpm.html">DPM Control</a>
      <a class="btn" href="/settings.html">Settings</a>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h2>Relays</h2>
      <div id="relays" class="row"></div>
    </section>
  </main>
  <footer>© DPM UI</footer>

  <script type="module">
    import {getJSON, postJSON, setActiveNav, $} from '/app.js';
    setActiveNav('nav-relays');

    function render(mask, limit=8){
      const box = $('#relays'); box.innerHTML='';
      for(let i=1;i<=limit;i++){
        const on = ((mask>>(i-1)) & 1) !== 0;
        const btn = document.createElement('button');
        btn.className = 'btn ' + (on?'primary':'');
        btn.textContent = `Relay ${i}: ` + (on?'ON':'OFF');
        btn.onclick = async()=>{
          const state = on ? 'off' : 'on';
          await postJSON('/api/relay', {id:i, state});
          refresh();
        };
        box.appendChild(btn);
      }
    }

    async function refresh(){
      try{
        const s = await getJSON('/api/relays'); // {mask: <uint8>}
        render(s.mask ?? 0);
      }catch(e){ $('#relays').innerHTML = '<span class="badge bad">No data</span>'; }
    }
    refresh();
    setInterval(refresh, 1000);
  </script>
</body>
</html>
